![image-20200518213906325](https://github.com/Rayassss/Homework/blob/master/Related%20Pic/image-20200518213906325.png)

# 一个综合的设计任务

## 任务目的

1.设计一个温湿度检测系统，同时使用STM32芯片的内部温度传感器和外部的DHT11温湿度传感器对环境参数进行监控；

2.将所读到的数据可以用使用串口助手进行检测，在PC上进行显示；

3.所读到的数据可以使用液晶显示屏进行显示；

4.系统完成传感器数据的读取和显示后，即进入低功耗模式（睡眠，停机，待机模式）要求每一分钟唤醒一次，并对传感器数据进行下一次测量和显示；

5。额外任务：传感器数据的远程发送。

## 任务分析

### 硬件电路

![image-20200519113617496](D:\Desktop\Ray_Homework\Related Pic\image-20200519113617496.png)

![image-20200519113812726](D:\Desktop\Ray_Homework\Related Pic\image-20200519113812726.png)

#### MCU

- 采用STM32F103C8T6，内载Cortex-M3Cortex-M3内核，CPU最高速度达72 MHz。该产品系列具有16KB ~ 1MB Flash、多种控制外设、USB全速接口和CAN，适用于开发需求较低的产品

#### ESP8266

- ESP8266EX 集成了 32 位 Tensilica 处理器、标准数字外设接口、天线开关、射频 balun、功率放大器、低噪放大器、过滤器和电源管理模块等，仅需很少的外围电路，可将所占 PCB 空间降低。
- ESP8266EX 的工作温度范围大，且能够保持稳定的性能，能适应各种操作环境。
- ESP8266EX 专为移动设备、可穿戴电子产品和物联网应用而设计，通过多项专有技术实现了超低功耗。ESP8266EX 具有的省电模式适用于各种低功耗应用场景。
- ESP8266EX 内置超低功耗 Tensilica L106 32 位 RISC 处理器，CPU 时钟速度最高可达 160 MHz，支持实时操作系统 (RTOS) 和 Wi-Fi 协议栈，可将高达 80% 的处理能力留给应用编程和开发。

#### USB-TTL

- 采用CH330N电平转换芯片，只需要一根USB数据线便可通过串口1与PC传输数据。

#### LCD

- 采用了1.8寸的TFT彩屏，通过模拟SPI总线通信。

#### DHT11

- 常见的温湿度传感器，仅用一根**DATA**总线便可完成数据的传输

#### 时钟树

![时钟树](D:\Desktop\Ray_Homework\Related Pic\时钟树.png)

#### 电源树

![电源树](D:\Desktop\Ray_Homework\Related Pic\电源树.jpg)

### 程序

#### 协议

- UART

  - STM32先与CH330通信，CH330采用串口协议与PC通信，用串口1烧录程序，打印动态曲线到串口助手上进行显示
- 采用串口协议与ESP8266通信
  - 好处是硬件接口简单，不需要用其他外部硬件，方便进行程序调试
- SPI

- One wire
- TCP
  - 点对点的通信协议，全双工模式，在这里用于ESP8266与我的阿里云服务器的连接，服务器可以处在不断接受ESP8266的数据的状态下
- MQTT
  - MQTT（Message Queuing Telemetry Transport，消息队列遥测传输协议），是一种基于发布/订阅（publish/subscribe）模式的"轻量级"通讯协议，该协议构建于TCP/IP协议上。
  - MQTT是一个基于客户端-服务器的消息发布/订阅传输协议
  - 考虑到TCP协议只能支持点对点的工作方式，而在智能家居的大背景下，显然会不只一个用户会订阅家居反馈的消息，这便有了MQTT的使用价值，基于服务器和多台移动设备的连接，用户可自由选择是否订阅服务器的数据而不会与TCP协议一样不订阅数据就会报错等缺陷

#### 功能

##### 温湿度检测

- 根据时序图初始化DHT11，首先主机至少拉低总线18ms，后恢复拉高总线20-40us等待从机的80us左右的低电平响应，若检验到连接成功的信号则总线拉高准备接受数据
- ![image-20200519115229899](D:\Desktop\Ray_Homework\Related Pic\image-20200519115229899-1589940589600.png)

##### ![image-20200519115246397](D:\Desktop\Ray_Homework\Related Pic\image-20200519115246397.png)

##### 在LCD上动态绘制温湿度曲线

- 在程序中共有三条不同颜色的动态曲线，温度，湿度，单片机内部温度，其中每条曲线共有64个节点用于描绘图形，每个节点之间相连

- 用了单向链表来实现当每条曲线的数据量超过64个时，头节点的舍去和尾节点的进位，以及新的数据量成为尾节点，使得算法的时间复杂度降至O（1）

- 这里对其中两个重要函数进行分析，其他的则显而易见了

  ```c
  void Free_Node(Curve_List_Node_t *NodeNum)// 释放节点
  {
  	NodeNum->Content = 0xFFFFFFFFUL;
  	NodeNum->pNext = (unsigned int *)0xFFFFFFFF;
  }
  Curve_List_Node_t *Malloc_Node(void)// 标记空节点
  {
  	unsigned int counter;
  	for(counter = 0 ; counter < Node_Length * List_Num ; counter++)
  	{
  		if( FreeNode[counter].Content == 0xFFFFFFFFUL )
  			return &FreeNode[counter];
  	}
  	return 0x00000000UL;
  }
  ```

  如图，当每条曲线的数据量多于64个时，为了更新数据，需要释放第一个数据的空间，在这里将其标记为0xFFFFFFFFUL，原因是温度或者地址的值不可能达到全满的状态；而第二个标记空节点的函数在for循环中扫描到刚刚被释放的空间，也就是检测其值或其地址为0xFFFFFFFFUL时，可以通过返回值告诉List_Append完成数据的迭代。

##### 实时操作系统FREEROTS

- 考虑到本次项目需要完成数据的采集，数据与pc的传输，数据与lcd的传输，数据与ESP8266的传输，而每次传输的时间难以敲定，不能用简单的延时实现，而且若大量使用中断程序，其中由于中断申请的变量有限且不大，就使用了实时操作系统FREEROTS来完成任务的调度
- 实时操作系统与一般的操作系统相比，最大的特色就是“实时性”，如果有一个任务需要执行，实时操作系统会马上（在较短时间内）执行该任务，不会有较长的延时。这种特性保证了每个程序按照自身的不同频率运行且程序之间相互配合有序井然。

##### 低功耗模式

- 睡眠模式，每一分钟唤醒一次，结合了FREEROTS中自带的SYSTICK，每次进入低功耗时，所有外设的时钟关闭，达到真正的“低功耗模式”，当每次唤醒时，由FREEROTS调度任务，唤醒DHT11收集数据完成一次完整的项目任务。

##### 联网订阅

- MCU通过串口2将数据发送到ESP8266，此时ESP再通过微信的airkiss协议完成与WiFi的配网，再通过TCP协议发送到我的阿里云服务器，解决了TCP的点对点和需要实时订阅的问题
- 基于TCP的协议在使用MQTT协议，实现了一对多，自愿订阅的功能



